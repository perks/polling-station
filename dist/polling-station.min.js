/*!
 * polling-station
 * 
 * 
 * @author Chris Evans
 * @version 0.0.1
 * Copyright 2014. MIT licensed.
 */
!function(){var a={getItem:function(a){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(a,b,c,d,e,f){if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return!1;var g="";if(c)switch(c.constructor){case Number:g=1/0===c?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:g="; expires="+c;break;case Date:g="; expires="+c.toUTCString()}return document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+g+(e?"; domain="+e:"")+(d?"; path="+d:"")+(f?"; secure":""),!0},removeItem:function(a,b,c){return a&&this.hasItem(a)?(document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(b?"; path="+b:""),!0):!1},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};window.cookieLib=a,WebFontConfig={google:{families:["Lato:100,300,400,700:latin"]}}}(),function(){var a=document.createElement("script");a.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",a.type="text/javascript",a.async="true";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b)}(),function(){function a(a){var b=this,c=function(a){var c,d=b.getElement(),e=d.querySelector("#poll-question"),f=d.querySelectorAll(".poll-answer"),g=d.querySelectorAll(".poll-result"),h=d.querySelectorAll(".poll-answer > .poll-answer-text"),i=d.querySelectorAll(".poll-answer > img"),j=d.querySelectorAll("#poll-results .poll-result-text"),k=d.querySelectorAll("#poll-results .poll-result-caption");if(e&&(e.innerHTML=a.question),f.length)for(c=0;c<f.length;c++)h.length?(h[c].innerHTML=a.answers[c].value,i.length&&(i[c].src="../assets/img/answer_"+f[c].getAttribute("data-id")+".png")):f[c].innerHTML=a.answers[c].value;if(g.length)for(c=0;c<g.length;c++)j.length?j[c].innerHTML=a.answers[c].value:g[c].innerHTML=a.answers[c].value+"% ("+a.answers[c].count+" votes)",k.length&&(k[c].innerHTML=a.answers[c].percent+"% ("+a.answers[c].count+" votes)");return d.innerHTML};this.options={id:a.id||1,el:a.el||"#polling-widget",url:a.url||"",template:a.template||c,localStorage:a.localStorage||!1,poll:a.poll||null},this.poll=a.poll,this.id=this.options.id,this.changeEvent=new Event("poll-change"),this.getElement().addEventListener("poll-change",function(){b.unbindToEvents(),b.loadPoll(b.id),b.swap("poll-answers","poll-results"),setTimeout(function(){var a=b.getElement().querySelectorAll("#poll-results .graph");if(a)for(var c=0;c<a.length;c++)a[c].style.width=b.poll.answers[c].percent+"%"},300)}),this.bindToEvents=function(){var a=b.getElement().querySelectorAll(".poll-answer"),c=b.getElement().querySelectorAll(".poll-answer > img"),d=Array.prototype.forEach;a&&d.call(a,function(a){var c=a.getAttribute("data-id");a.addEventListener("click",function(a){a.preventDefault(),b.updateSelection(c),b.getElement().dispatchEvent(b.changeEvent)})}),c&&d.call(c,function(a){a.onmouseover=function(){a.src=a.src.replace(/(\.[\w\d_-]+)$/i,"_hover$1")},a.onmouseout=function(){a.src=a.src.substring(0,a.src.lastIndexOf("_hover"))+".png"}})},this.unbindToEvents=function(){var a=b.getElement().querySelectorAll(".poll-answer > img"),c=Array.prototype.forEach;a&&c.call(a,function(a){a.onmouseover=null,a.onmouseout=null})},this.init=function(){cookieLib.hasItem("poll-vote")&&(cookieLib.removeItem("poll-vote"),console.log("remove cookie;")),b.poll?(b.render(b.poll),b.bindToEvents()):b.loadPoll(b.id,b.bindToEvents)},this.swap=function(a,b){document.getElementById(a).style.display="none",document.getElementById(b).style.display="block"}}a.prototype.getElement=function(){return document.getElementById(this.options.el.replace(/^#/,""))},a.prototype.fetchPoll=function(a,b,c){function d(){e.readyState<4||200!==e.status||4==e.readyState&&c(e)}var e=new XMLHttpRequest,f=a+"/polls/"+b;e.onreadystatechange=d,e.open("GET",f,!0),e.send(null)},a.prototype.save=function(a,b){cookieLib.setItem("poll-vote",this.id);var c=this,d=a||this.id,e=b||this.poll;if(this.poll=e,this.id=d,this.options.localStorage&&(localStorage.removeItem("poll"+d),localStorage.setItem("poll"+d,JSON.stringify(e))),this.options.url){var f=new XMLHttpRequest,g=this.options.url+"/polls/"+c.id+"/vote/"+d;console.log(g),f.onreadystatechange=function(){4==f.readyState&&(200<=f.status&&f.status<300?console.log("save successfull"):(console.log("error saving - defaulting to load from local storage"),c.options.url=null,c.options.localStorage=!0))},f.open("POST",g,!0),f.send(null)}},a.prototype.loadPoll=function(a,b){function c(a){var c=JSON.parse(a.responseText);c=c.response.poll,console.log(c),e.render(c),e.poll=c,b()}var b=b||function(){};if(!this.options.url&&this.options.localStorage){var d=JSON.parse(localStorage.getItem("poll"+a));this.render(d),this.poll=d,b()}else if(this.options.url){var e=this;this.fetchPoll(this.options.url,a,c)}else{var f={question:"Did I want a default data model?",answers:[{value:"Yes",count:10,percent:0},{value:"No",count:20,percent:0}],total:0};this.render(f),this.poll=f,b()}},a.prototype.render=function(a){var b=this.options.template(a);this.getElement().innerHTML=b},a.prototype.updateSelection=function(a){cookieLib.hasItem("poll-vote")?console.log("already voted"):(console.log("im saving"),this.lookup(a).count++,this.recalibrate(),this.save(this.lookup(a).id,this.poll))},a.prototype.recalibrate=function(){this.poll.total=0;var a=this.poll.answers;for(var b in a)this.poll.total+=a[b].count;for(var c in a)this.poll.answers[c].percent=Math.round(this.poll.answers[c].count/this.poll.total*100)},a.prototype.lookup=function(a){if(this.lookup_arr=[],!this.lookup_arr.length)for(var b=this.poll.answers,c=0;c<b.length;c++)this.lookup_arr[b[c].id]=b[c];return this.lookup_arr[a]},window.PollingWidget=a}();