/*!
 * polling-station
 * 
 * 
 * @author Chris Evans
 * @version 0.0.1
 * Copyright 2014. MIT licensed.
 */
!function(){var a={getItem:function(a){return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*([^;]*).*$)|^.*$"),"$1"))||null},setItem:function(a,b,c,d,e,f){if(!a||/^(?:expires|max\-age|path|domain|secure)$/i.test(a))return!1;var g="";if(c)switch(c.constructor){case Number:g=1/0===c?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+c;break;case String:g="; expires="+c;break;case Date:g="; expires="+c.toUTCString()}return document.cookie=encodeURIComponent(a)+"="+encodeURIComponent(b)+g+(e?"; domain="+e:"")+(d?"; path="+d:"")+(f?"; secure":""),!0},removeItem:function(a,b,c){return a&&this.hasItem(a)?(document.cookie=encodeURIComponent(a)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(c?"; domain="+c:"")+(b?"; path="+b:""),!0):!1},hasItem:function(a){return new RegExp("(?:^|;\\s*)"+encodeURIComponent(a).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};window.cookieLib=a}(),function(){function a(a){var b=this,c={id:1,el:"#polling-station",url:"",localStorage:!1,dev:!0,base:"./",template:this.defaultTemplateFunc,poll:null};this.options={id:a.id||c.id,el:a.el||c.el,url:a.url||c.url,template:a.template||c.template,localStorage:"undefined"==typeof a.localStorage||null===a.localStorage?c.localStorage:a.localStorage,dev:"undefined"==typeof a.dev||null===a.dev?c.dev:a.dev,poll:a.poll||c.poll,base:a.base||c.base},this.poll=this.options.poll,this.id=parseInt(this.options.id,10),this.changeEvent=document.createEvent("Event"),this.changeEvent.initEvent("poll-change",!0,!0),this.readyEvent=document.createEvent("Event"),this.readyEvent.initEvent("poll-ready",!0,!0),this.registerEvents=function(){var a=this;a.getElement().addEventListener("poll-change",function(){function b(){var b=a.getElement().querySelectorAll("#poll-results .graph");if(b)for(var c=0;c<b.length;c++)b[c].style.width=a.poll.answers[c].percent+"%"}a.unbindEvents(),a.swap("poll-answers","poll-results"),setTimeout(b,300)}),a.getElement().addEventListener("poll-ready",function(){a.bindEvents.call(a)})},this.bindEvents=function(){var a=this,b=a.getElement().querySelectorAll(".poll-answer"),c=a.getElement().querySelectorAll(".poll-answer > img"),d=Array.prototype.forEach;b&&d.call(b,function(b){var c=b.getAttribute("data-id");b.addEventListener("click",function(b){b.preventDefault(),a.updateSelection(c),a.getElement().dispatchEvent(a.changeEvent)})}),c&&d.call(c,function(a){a.onmouseover=function(){a.src=a.src.replace(/(\.[\w\d_-]+)$/i,"_hover$1")},a.onmouseout=function(){a.src=a.src.substring(0,a.src.lastIndexOf("_hover"))+".png"}})},this.unbindEvents=function(){var a=b.getElement().querySelectorAll(".poll-answer > img"),c=Array.prototype.forEach;a&&c.call(a,function(a){a.onmouseover=null,a.onmouseout=null})},this.swap=function(a,b){document.getElementById(a).style.display="none",document.getElementById(b).style.display="block"},this.init=function(a){var a=a||[];b.options.dev&&(console.log("PollingStation: Dev Mode Enabled"),cookieLib.removeItem("poll-vote")),!b.poll||b.poll&&(b.options.localStorage||b.options.url)?b.loadPoll(b.id,a):(b.render(b.poll),a.forEach(function(a){a()}),b.registerEvents(),b.bindEvents())}}a.prototype.getElement=function(){return document.getElementById(this.options.el.replace(/^#/,""))},a.prototype.defaultTemplateFunc=function(a){var b,c=document.getElementById(this.el.replace(/^#/,"")),d=c.querySelector("#poll-question"),e=c.querySelectorAll(".poll-answer"),f=c.querySelectorAll(".poll-result"),g=c.querySelectorAll(".poll-answer > .poll-answer-text"),h=c.querySelectorAll(".poll-answer > img"),i=c.querySelectorAll("#poll-results .poll-result-text"),j=c.querySelectorAll("#poll-results .poll-result-caption");if(d&&(d.innerHTML=a.question),e.length)for(b=0;b<e.length;b++)g.length?(g[b].innerHTML=a.answers[b].value,h.length&&(h[b].src=this.base+"assets/img/"+a.answers[b].value+".png")):e[b].innerHTML=a.answers[b].value;if(f.length)for(b=0;b<f.length;b++)i.length?i[b].innerHTML=a.answers[b].value:f[b].innerHTML=a.answers[b].value+"% ("+a.answers[b].count+" votes)",j.length&&(j[b].innerHTML=a.answers[b].percent+"% ("+a.answers[b].count+" votes)");return c.innerHTML},a.prototype.fetchPoll=function(a,b,c){function d(){e.readyState<4||200!==e.status||4==e.readyState&&c(e)}var e=new XMLHttpRequest,f=a+"/polls/"+b;e.onreadystatechange=d,e.open("GET",f,!0),e.send(null)},a.prototype.save=function(a,b){cookieLib.setItem("poll-vote",this.id);var c=this,d=a||1,e=b||this.poll;if(this.poll=e,this.options.localStorage&&(localStorage.removeItem("poll-"+c.id),localStorage.setItem("poll-"+c.id,JSON.stringify(e))),this.options.url){var f=new XMLHttpRequest,g=this.options.url+"/polls/"+c.id+"/vote/"+d;f.onreadystatechange=function(){4==f.readyState&&(200<=f.status&&f.status<300?console.log("save successfull"):(console.log("error saving - defaulting to load from local storage"),c.options.url=null,c.options.localStorage=!0))},f.open("POST",g,!0),f.send(null)}},a.prototype.loadPoll=function(a,b){function c(a){var c=JSON.parse(a.responseText);c=c.response.poll,e.poll=c,e.id=c.id,e.render(c),e.registerEvents(),e.getElement().dispatchEvent(e.readyEvent),b.forEach(function(a){a()})}var b=b||[];if(!this.options.url&&this.options.localStorage){var d,e=this;d=localStorage.getItem("poll"+a)?JSON.parse(localStorage.getItem("poll"+a)):this.poll,this.poll=d,this.render(d),e.registerEvents(),e.getElement().dispatchEvent(e.readyEvent),b.forEach(function(a){a()})}else if(this.options.url){var e=this;this.fetchPoll(this.options.url,a,c)}else{var f={question:"Did I want a default data model?",answers:[{value:"Yes",count:10,percent:0},{value:"No",count:20,percent:0}],total:0};this.render(f),this.poll=f,this.registerEvents(),this.bindEvents(),b.forEach(function(a){a()})}},a.prototype.render=function(a){cookieLib.hasItem("poll-vote")&&parseInt(cookieLib.getItem("poll-vote"),10)===this.id&&this.getElement().dispatchEvent(this.changeEvent);var b=this.options.template(a);this.getElement().innerHTML=b},a.prototype.updateSelection=function(a){cookieLib.hasItem("poll-vote")&&parseInt(cookieLib.getItem("poll-vote"),10)===this.id?console.log("already voted"):(this.lookup(a).count++,this.recalibrate(),this.save(this.lookup(a).id))},a.prototype.recalibrate=function(){this.poll.total=0;var a=this.poll.answers;for(var b in a)this.poll.total+=a[b].count;for(var c in a)this.poll.answers[c].percent=Math.round(this.poll.answers[c].count/this.poll.total*100)},a.prototype.lookup=function(a){if(this.lookup_arr=[],!this.lookup_arr.length)for(var b=this.poll.answers,c=0;c<b.length;c++)this.lookup_arr[b[c].id]=b[c];return this.lookup_arr[a]},window.PollingStation=a}();